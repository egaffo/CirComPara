'''
Perform analyses on the circRNA results collected by each circRNA detection program.
Currently supported/implemented for:
    * CIRCexplorer
    * CIRI
    * findcirc
    * segecirc (segemehl)
'''

Import('*')

try:
    env = env.Clone()
    circrna_analyze_circexplorer
    circrna_analyze_ciri        
    circrna_analyze_findcirc    
    circrna_analyze_segecirc    
    GTF = circrna_analyze_GTF

except NameError:
    vars = Variables('vars.py')
    vars.Add('CSVS', '''A comma-separated list with the four circRNA result collection csv'''\
             ''' files. The order must be CIRCexplorer,ciri,find_circ,segecirc ''', 
             '''CIRCexplorer_compared.csv,ciri_compared.csv,find_circ_compared.csv,'''\
             '''segecirc_compared.csv''')
    vars.Add('GTF', 'The annotation file in GTF format to be intersected', 'merged.gtf')
    env = Environment(ENV=os.environ, SHELL = '/bin/bash',
                      variables=vars)
    Help(vars.GenerateHelpText(env))
    unknown = vars.UnknownVariables()
    if unknown:
        print "Run sample: unknown variables", unknown.keys()
        Exit(1)

    csvs = env['CSVS'].rstrip().split(',')
    circrna_analyze_circexplorer = csvs[0]
    circrna_analyze_ciri         = csvs[1]
    circrna_analyze_findcirc     = csvs[2]
    circrna_analyze_segecirc     = csvs[3]
    GTF = env['GTF']

## set logging id
log_id = "[COLLECT CIRCRNAS]"
try:
    env['LOG_PREFIX'] = env['LOG_PREFIX'] + log_id
except KeyError:
    env['LOG_PREFIX'] = log_id

env['ENV']['LOG_PREFIX'] = env['LOG_PREFIX']

## collect circRNAs in a single GTF annotation file
circ_gtf_cmd = '''{ convert_circrna_collect_tables.py -p circexplorer ${SOURCES[0]}; '''\
   '''convert_circrna_collect_tables.py -p ciri ${SOURCES[1]}; '''\
   '''convert_circrna_collect_tables.py -p findcirc ${SOURCES[2]}; '''\
   '''convert_circrna_collect_tables.py -p segecirc ${SOURCES[3]}; } | '''\
   '''sort -k1,1 -k4,4n > ${TARGETS[0]} '''
circ_gtf_sources = [circrna_analyze_circexplorer, circrna_analyze_ciri, 
                    circrna_analyze_findcirc, circrna_analyze_segecirc]

circ_gtf_target = 'circrnas.gtf'
circ_gtf = env.Command(circ_gtf_target, circ_gtf_sources, circ_gtf_cmd)

## intersect circRNAs with gene annotation
circ_gene_combine_cmd = '''bedtools intersect -wa -wb -a ${SOURCES[0]} -b ${SOURCES[1]} -s -loj'''\
                        ''' | gzip -c > $TARGET'''
circ_gene_combine_sources = [circ_gtf, GTF]
circ_gene_combine_target = 'combined_circrnas.gtf.gz'
circ_gene_combine = env.Command(circ_gene_combine_target, circ_gene_combine_sources, 
                                circ_gene_combine_cmd)

Return('circ_gene_combine circ_gtf')
